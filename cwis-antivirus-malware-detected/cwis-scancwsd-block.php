<?php

/**
 * The plugin guarder file
 *
 * @link              https://cobweb-security.com
 * @since             1.4.0
 * @package           Cwsd
 */
// Skip if accessed recursively
if (!defined('ABSPATH')) {

    define('ABSPATH', dirname(dirname(dirname(dirname(__FILE__)))) . '/');

    if ( file_exists( ABSPATH . 'wp-config.php' ) ) {
        require_once ABSPATH . 'wp-config.php';
    } elseif ( @file_exists( dirname( ABSPATH ) . '/wp-config.php' ) &&
        ! @file_exists( dirname( ABSPATH ) . '/wp-settings.php' ) ) {
        require_once dirname( ABSPATH ) . '/wp-config.php';
    }

    require_once(CWIS_PLUGIN_DIR_PATH . 'cwis-scan/bootstrap.php');

    // Include the guarder and block user if not whitelisted

    $cwis_defender_guarder = new \App\Library\Cwis_Defender_Guarder();
    if (!$cwis_defender_guarder->is_client_whitelisted() &&
            !$cwis_defender_guarder->is_search_engine_bot()) {

        // Check for user IP in database
        if (false !== ($packed_entry = $cwis_defender_guarder->check_user_ip())) {
            $cwis_defender_guarder->block_user_access($packed_entry);
        }

        // Insert IP and block user
        $cwis_defender_guarder->block_user_ip();
    }
}
