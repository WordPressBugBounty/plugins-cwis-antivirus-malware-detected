<?php

defined( 'ABSPATH' ) || exit;

use App\Middlewares\AjaxAuthMiddleware;
use App\Middlewares\RestAuthMiddleware;
use App\Middlewares\PermissionsMiddleware;

use App\State;
use DI\Container;
use Slim\Factory\AppFactory;

require_once __DIR__ . '/config/cwis-compat.php';
require_once __DIR__ . '/config/debug.php';

if(!defined('CWIS_PLATFORM_TYPE')) {
    define('CWIS_PLATFORM_TYPE', 'wordpress');
}

require __DIR__ . '/vendor/autoload.php';

State::loadTranslations(State::detectLang());
State::loadConfig(CWIS_PLATFORM_TYPE);

$container = new Container();
$app = AppFactory::createFromContainer($container);

header("Access-Control-Allow-Origin: *");
header("Access-Control-Allow-Headers: *");

if (function_exists('header_remove')) {
    header_remove('X-Powered-By'); // PHP 5.3+
} else {
    @ini_set('expose_php', 'off');
}

$basePath = strpos($_SERVER['REQUEST_URI'], 'wp-json') !== false ? '/wp-json/cwis/v5/api' : $_SERVER['SCRIPT_NAME'];
$app->setBasePath($basePath);
$app->group('', function($group){
    $group->post('', [\App\Controller::class, 'ajax']);
    $group->get('', [\App\Controller::class, 'ajax']);
    $group->post('/deltas', [\App\Controller::class, 'deltas']);
})->add(AjaxAuthMiddleware::class)->add(PermissionsMiddleware::class);

$app->run();
