<?php

namespace App\Library;

class CwisSec
{

    var $rips_scan;

    function construct($file_name = '', $file_contents = '')
    {
        $scan_functions = array_merge(
            CwisSecSinks::$F_XSS, CwisSecSinks::$F_HTTP_HEADER, CwisSecSinks::$F_SESSION_FIXATION, CwisSecSinks::$F_CODE,
            CwisSecSinks::$F_REFLECTION, CwisSecSinks::$F_FILE_READ, CwisSecSinks::$F_FILE_AFFECT, CwisSecSinks::$F_FILE_INCLUDE,
            CwisSecSinks::$F_EXEC, CwisSecSinks::$F_DATABASE, CwisSecSinks::$F_XPATH, CwisSecSinks::$F_LDAP,
            CwisSecSinks::$F_CONNECT, CwisSecSinks::$F_POP, CwisSecSinks::$F_OTHER
        );
        $info_functions = CwisSecInfo::$F_INTEREST;
        $source_functions = array_merge(CwisSecSources::$F_OTHER_INPUT, CwisSecSources::$F_FILE_INPUT,
            CwisSecSources::$F_DATABASE_INPUT);

        $this->rips_scan = new CwisSecRipsScan($file_name, $file_contents, $scan_functions, $info_functions, $source_functions);
        $this->rips_scan->parse();
    }

    function parse_vars()
    {
        $t_parser = new CwisSecParser();

        foreach ($this->rips_scan->var_declares_global as $var_declares_global) {
            foreach ($var_declares_global as &$var_declare) {
                $t_parser->set_tokens($var_declare->tokens);
                $t_parser->evaluate_expressions();
                $t_parser->parse_concatenations();
                $t_parser->evaluate_functions();
                $t_parser->parse_concatenations();
                $var_declare->parsedtokens = array_values(array_filter($t_parser->get_tokens()));
            }
        }

        foreach ($this->rips_scan->var_declares_local as $var_declares_local) {
            foreach ($var_declares_local as &$var_declare) {
                $t_parser->set_tokens($var_declare->tokens);
                $t_parser->evaluate_expressions();
                $t_parser->parse_concatenations();
                $t_parser->evaluate_functions();
                $t_parser->parse_concatenations();
                $var_declare->parsedtokens = array_values(array_filter($t_parser->get_tokens()));
            }
        }
    }

}
