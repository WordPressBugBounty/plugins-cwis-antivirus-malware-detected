<?php

namespace App\Adapters;

use App\Adapters\WpAdapter;

use App\Library\CwisUtilities;
use App\Library\Cwis_Updater_Methods;
use App\Library\Cwis;
use App\Library\CwisRuntime;
use App\Library\CwisTOTP;
use App\Library\CwisLogger;

use App\State;
use App\Actions\Register;
use App\Actions\Unregister;
use App\Actions\Deactivate;

use RecursiveDirectoryIterator;
use RecursiveIteratorIterator;

use DI\Container;
use Psr\Http\Message\ResponseInterface;
use Slim\Psr7\Response;
//use Slim\Views\Twig;
use App\Library\CwisApi;

class CwisWP {

    public function debug($message = '', $data = null, $stack = 2)
    {
        if (!$this->debugger) {
            return;
        }

        if (null === $data && null !== $stack) {
            $backtrace = debug_backtrace();
            $stack_message = 'Called ' . $backtrace[$stack]['function'] . '()'
              . ' from method ' . $backtrace[$stack + 1]['class'] . '::' . $backtrace[$stack + 1]['function'] . '()'
              . ', line ' . $backtrace[$stack]['line']
              . ' of ' . substr($backtrace[$stack]['file'], strlen(State::abspath()));
            $message = ($message ? $message . " \t" : $message) . $stack_message;
        } else {
            $message .= " \t" . preg_replace("/\s+/s", " ", print_r($data, 1));
        }

        $micro_time = microtime(true);
        $micro_seconds = sprintf("%06d", ($micro_time - floor($micro_time)) * 1000000);
        $log_entry = date("Y-m-d H:i:s.") . $micro_seconds . " \t" . $message . PHP_EOL;

        $path_to_log_file = CWIS_PLUGIN_DIR_PATH . 'tmp/debug.log';
        return @file_put_contents($path_to_log_file, $log_entry, FILE_APPEND | LOCK_EX);
    }

    protected $feed_uri = array(
        'https://cobweb-security.com/laboratory/feed',
    );

    public function get_version()
    {
        return State::cnf('CWIS_VERSION');
    }

    public function get_plugin_name()
    {
        return State::cnf('CWIS_NAME');
    }

    public function add_widget()
    {
        global $wp_meta_boxes;

        if (isset($wp_meta_boxes['dashboard']['normal']['core']['cobwebsec'])) {
            return;
        }

        wp_add_dashboard_widget('cobwebsec', 'WebDefender Security (formely CWIS Antivirus)',
            array(&$this, 'render_dashboard_widget'));
    }

    public function render_dashboard_widget()
    {
        // Get parsed and cached RSS feed items
        $rss_items = $this->get_rss_items();

        // Generate links to plugin page
        $cwis_scanner_url = 'admin.php?page=cwis-scanner';
        $cwis_updater_url = 'admin.php?page=cwis-updater';
        if (function_exists('network_admin_url')) {
            $cwis_scanner_url = network_admin_url($cwis_scanner_url);
            $cwis_updater_url = network_admin_url($cwis_updater_url);
        }

        // Get plugin module statuses
        $cwis_defender_settings = State::cnf("CWIS_DEFENDER");
        $cwis_defender_status = $cwis_defender_settings['smartwaf'];
        $cwis_updater_status = State::cnf('CWIS_CORE_UPDATES') || State::cnf('CWIS_PLUGIN_UPDATES') ||
        State::cnf('CWIS_THEME_UPDATES');
        ?>

        <style type="text/css">
            .cobwebsec-dashicon {
                font-size: 18px;
                vertical-align: text-top;
            }
            .cobwebsec-float-right {
                float: right;
            }
            .cobwebsec-text-gray {
                color: #72777c;
            }
            .cobwebsec-text-gray:hover {
                color: #62676c;
            }
            .cobwebsec-widget-header, .cobwebsec-widget-footer {
                margin: 1em -1em;
                padding: 1em;
            }
            .cobwebsec-widget-header {
                border-bottom: 1px solid #eee;
                padding-top: 0;
            }
            .cobwebsec-widget-header ul {
                margin: 0 0 -6px;
            }
            .cobwebsec-widget-rss ul li {
                padding: 4px 0;
                margin: 0;
            }
            .cobwebsec-widget-rss ul li p {
                margin: 4px 0;
            }
            .cobwebsec-widget-footer {
                color: #ddd;
                border-top: 1px solid #eee;
                padding-bottom: 0;
            }
        </style>

        <div class="cobwebsec-widget-header">
            <ul>
                <li>
                    <a href="<?php echo esc_url($cwis_scanner_url); ?>#/defender/settings">
                      <span class="cobwebsec-dashicon dashicons dashicons-shield"></span>
                      <strong><?php echo __('Smart Protection', CWIS_PLUGIN_SLUG); ?></strong>
                      <span class="cobwebsec-float-right cobwebsec-text-gray"><?php
                          echo __($cwis_defender_status ? 'Enabled' : 'Disabled', CWIS_PLUGIN_SLUG);
                          ?></span>
                    </a>
                </li>
                <li>
                    <a href="<?php echo esc_url($cwis_updater_url); ?>">
                    <span class="cobwebsec-dashicon dashicons dashicons-admin-settings"></span>
                    <strong><?php echo __('WebDefender Updater', CWIS_PLUGIN_SLUG); ?></strong>
                    <span class="cobwebsec-float-right cobwebsec-text-gray"><?php
                      echo __($cwis_updater_status ? 'Active' : 'Inactive', CWIS_PLUGIN_SLUG);
                      ?></span>
                    </a>
                </li>
                <li>
                    <a href="<?php echo esc_url($cwis_scanner_url); ?>">
                    <span class="cobwebsec-dashicon dashicons dashicons-clock"></span>
                    <strong><?php echo __('Last Scanner Activity', CWIS_PLUGIN_SLUG); ?></strong>
                    <span class="cobwebsec-float-right cobwebsec-text-gray"><?php
                      State::cnf('CWIS_LAST_SCAN') ?
                          printf(__('%s ago', CWIS_PLUGIN_SLUG),
                              human_time_diff(State::cnf('CWIS_LAST_SCAN'))) :
                          print(__('N/A', CWIS_PLUGIN_SLUG));
                      ?></span>
                    </a>
                </li>
                <li>
                    <em style="font-size:smaller"><sup>*</sup> Once a week is generally a recommended frequency for a full system scan.
                    This allows your antivirus scanner to run the newest virus definition files against your server system.</em>
                </li>
            </ul>
        </div>

        <div class="cobwebsec-widget-rss">
            <ul>
                <?php if (empty($rss_items)) : ?>
                    <li><?php _e('No items', CWIS_PLUGIN_SLUG); ?></li>
                <?php else : ?>
                    <?php // Loop through each feed item and display each item as a hyperlink.   ?>
                    <?php foreach ($rss_items as $item) : ?>
                        <li>
                            <a href="<?php
                                echo add_query_arg(
                                  array('utm_campaign' => 'feed', 'utm_medium' => 'dashboard_widget'),
                                  esc_url($item['link'])
                                );
                            ?>" target="_blank" title="<?php esc_html($item['date']); ?>"><?php
                              echo esc_html($item['title']);
                              ?></a>
                            <?php /* if ($item['description']): ?>
                            <p><?php echo esc_html($item['description']); ?></p>
                            <?php endif; */ ?>
                        </li>
                    <?php endforeach; ?>
                <?php endif; ?>
            </ul>
        </div>

        <p class="cobwebsec-widget-footer">
            <a href="https://wordpress.org/plugins/cwis-antivirus-malware-detected/#developers" target="_blank"
                class="cobwebsec-float-right">
                <span class="cobwebsec-text-gray">Version <?php echo $this->get_version(); ?></span>
                <span class="screen-reader-text">(opens in a new window)</span>
            </a>

            <a href="https://cobweb-security.com/our-product/" target="_blank">Our Products
                <span class="screen-reader-text">(opens in a new window)</span><span aria-hidden="true" class="dashicons dashicons-external"></span>
            </a>
    |

            <a href="https://cobweb-security.com/website-under-attack/" target="_blank">Fix &amp; Protect
                <span class="screen-reader-text">(opens in a new window)</span><span aria-hidden="true" class="dashicons dashicons-external"></span>
            </a>
    |

            <a href="https://cobweb-security.com/blog/" target="_blank">Blog
                <span class="screen-reader-text">(opens in a new window)</span><span aria-hidden="true" class="dashicons dashicons-external"></span>
            </a>
        </p>
    <?php
    }

    private function get_rss_items()
    {
        if (false === ($rss_items = get_transient('cobwebsec_feed_items'))) {
            $rss_items = array();

            // Get a SimplePie RSS feed object
            include_once( State::abspath() . WPINC . '/feed.php' );
            $rss = fetch_feed($this->feed_uri);
            if (!is_wp_error($rss)) {
                // Figure out how many total items there are, but limit it to 5.
                $max_items = $rss->get_item_quantity(5);

                // Build an array of all the items, starting with element 0 (first element).
                $items = $rss->get_items(0, $max_items);
                foreach ($items as $item) {
                  $rss_items[] = array(
                      'title' => $item->get_title(),
                      //'description' => wp_trim_words(strip_tags($item->get_description()), 30),
                      'date'  => sprintf(__('Posted %s', CWIS_PLUGIN_SLUG), $item->get_date('j F Y | g:i a')), //$item->get_date('U'),
                      'link'  => $item->get_permalink(),
                  );
                }
                set_transient('cobwebsec_feed_items', $rss_items, 24 * HOUR_IN_SECONDS);
            }
        }

        return $rss_items;
    }

    private $icon_url = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgeD0iMCIgeT0iMCIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMTAwIDEwMCIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PHBhdGggZD0iTTk3LjYgNTYuMWMtOS4zLTYuNS0xOS45LTkuOC0yOC4zLTExLjQgNi44LTMuMiAxNC42LTguOSAyMS41LTE4LjYgMS0xLjUgLjctMy41LS44LTQuNSAtMS41LTEtMy41LS43LTQuNiAuOCAtNi42IDkuNC0xNC4yIDE0LjUtMjAuNCAxNy4yIDMuOC00LjcgNy44LTEyLjEgMTEuNC0yMy45IC41LTEuNy0uNS0zLjUtMi4yLTQuMSAtMS43LS41LTMuNSAuNS00LjEgMi4yIC01LjQgMTguMi0xMS44IDI0LjMtMTUuMyAyNi4zIC0uNS0xLjMtMS4zLTIuNC0yLjMtMyAuMS0uNCAuMi0uOCAuMi0xLjIgMC0xLjYtLjgtMy0xLjktMy4zbC0uNCAzLjhjLS4xIDAtLjIgMC0uMyAwcy0uMiAwLS4zIDBsLS40LTMuOGMtMS4xIC40LTEuOSAxLjctMS45IDMuMyAwIC40IC4xIC44IC4yIDEuMiAtMSAuNy0xLjggMS43LTIuMyAzIC0zLjUtMi05LjgtOC4xLTE1LjMtMjYuMyAtLjUtMS43LTIuMy0yLjctNC4xLTIuMiAtMS43IC41LTIuNyAyLjMtMi4yIDQuMSAzLjUgMTEuNyA3LjUgMTkuMSAxMS4zIDIzLjggLTYuMi0yLjctMTMuOC03LjctMjAuMy0xNy4xIC0xLTEuNS0zLjEtMS44LTQuNS0uOCAtMS41IDEtMS44IDMuMS0uOCA0LjYgNi45IDkuOCAxNC43IDE1LjQgMjEuNSAxOC42IC04LjQgMS42LTE5LjEgNC45LTI4LjMgMTEuNCAtMS41IDEtMS44IDMuMS0uOCA0LjYgLjYgLjkgMS42IDEuNCAyLjcgMS40IC43IDAgMS4zLS4yIDEuOS0uNiA5LjItNi41IDIwLjItOS40IDI4LjMtMTAuNyAtNi44IDUuOS0xNC44IDE3LjEtMjEuNiAzOC4yIC0uNiAxLjcgLjQgMy42IDIuMSA0LjEgLjMgLjEgLjcgLjIgMSAuMiAxLjQgMCAyLjctLjkgMy4xLTIuMyA2LTE4LjYgMTIuOC0yOC42IDE4LjMtMzQgLS41IDEuOC0uOCAzLjgtLjggNS45IDAgOS44IDUuOSAxNy43IDEzLjIgMTcuNyA3LjMgMCAxMy4yLTcuOSAxMy4yLTE3LjcgMC0yLjEtLjMtNC0uOC01LjkgNS41IDUuNCAxMi4zIDE1LjUgMTguMyAzNCAuNCAxLjQgMS43IDIuMyAzLjEgMi4zIC4zIDAgLjctLjEgMS0uMiAxLjctLjYgMi43LTIuNCAyLjEtNC4xIC02LjgtMjEuMS0xNC45LTMyLjMtMjEuNy0zOC4yIDguMSAxLjMgMTkuMSA0LjIgMjguNCAxMC44IC42IC40IDEuMiAuNiAxLjkgLjYgMSAwIDItLjUgMi43LTEuNEM5OS41IDU5LjEgOTkuMSA1Ny4xIDk3LjYgNTYuMXoiIHN0cm9rZT0iZ3JheSIgZmlsbD0iYmxhY2siLz48L3N2Zz4=';
    private $plugin_assets_url;

    public function __construct()
    {
        $this->plugin_assets_url = plugin_dir_url(CWIS_PLUGIN_DIR_PATH) . State::cnf('CWIS_SLUG') . '/';
    }

    public function display_application_main_page()
    {
        if (!current_user_can('manage_options')) {
            $message = esc_html__('You do not have sufficient permissions to access this page.', CWIS_PLUGIN_SLUG);
            wp_die($message);
        }

        /*
        global $app;
        $view =  \Slim\Views\Twig::create(State::workPath().'/twig');
        $response = $app->getContainer()->get(Response::class);
        echo $view->render($response, 'admin/partials/application/main-page.html', [])->getBody();
        */

        echo '<div class="site-container"><div class="site-main"></div></div>';
    }

    /**
    * Register the function that contains the admin-bar-menu-building code.
    *
    * @since   3.2.3
    */
    public function enqueue_admin_bar_menu()
    {
        global $wp_admin_bar;

        // Adding menu to the Admin bar
        if (isset($wp_admin_bar)) {
            $custom_styles = '#wp-admin-bar-cwis-menu .ab-icon{transform:scaleX(-1)}#wp-admin-bar-cwis-menu .ab-icon:before{top:3px;content:"\f332"}';
            $wp_admin_bar->add_menu(array(
                'id'    => 'cwis-menu',
                'title' => '<span class="ab-icon"></span><span class="ab-label">WebDefender</span><style>' . $custom_styles . '</style>',
                'href'  => admin_url('admin.php?page=cwis-scanner'),
                'meta'  => array(
                    'target' => '_self',
                    'title'  => 'WebDefender Security (formely CWIS Antivirus)'
                ),
            ));
        }
    }

    /**
    * Register the function that contains the menu-building code for the admin area.
    *
    * @since    1.0.1
    */
    public function enqueue_admin_area_menu()
    {
        // Building the main menu
        $func_application = array($this, 'display_application_main_page');
        add_menu_page('WebDefender Security', 'WebDefender Security', 'manage_options', 'cwis-scanner', $func_application, $this->icon_url);

        // Building the submenu
        add_submenu_page('cwis-scanner', 'Dashboard', 'Dashboard', 'manage_options', 'cwis-scanner', $func_application);
        add_submenu_page('cwis-scanner', 'System Scan', 'System Scan', 'manage_options', 'cwis-scanner#scanner', $func_application);
        add_submenu_page('cwis-scanner', 'Scan Results', 'Scan Results', 'manage_options', 'cwis-scanner#results', $func_application);
        add_submenu_page('cwis-scanner', 'Smart Protection', 'Smart Protection', 'manage_options', 'cwis-scanner#defender', $func_application);
        add_submenu_page('cwis-scanner', 'Blacklist Check', 'Blacklist Check', 'manage_options', 'cwis-scanner#sitecheck', $func_application);
        add_submenu_page('cwis-scanner', 'System Info', 'System Info', 'manage_options', 'cwis-scanner#sysinfo', $func_application);
        add_submenu_page('cwis-scanner', 'Settings', 'Settings', 'manage_options', 'cwis-scanner#settings', $func_application);
    }

    /**
    * Register the function that generates notices for the admin area.
    *
    * @since    2.3.0
    */
    public function enqueue_admin_area_notices()
    {
        global $current_screen;
        global $pagenow;

        // Use global var or get current screen (since WP 3.1)
        if (empty($current_screen) && function_exists('get_current_screen')) {
            $current_screen = get_current_screen();
        }

        // Enqueue notices on dashboard and plugins pages only
        $current_screen_id = isset($current_screen->id) ? $current_screen->id : substr($pagenow, 0, -4);
        if ($current_screen_id !== 'index' && $current_screen_id !== 'dashboard' && $current_screen_id !== 'plugins') {
            return null;
        }

        // Check last scan time (7 * 86400 = week)
        if (time() - State::cnf('CWIS_LAST_SCAN') < 604800) {
            return null;
        }

        // Add a dismissible notice
        $cwis_scanner_url = 'admin.php?page=cwis-scanner';
        $network_admin_url = function_exists('network_admin_url') ?
        network_admin_url($cwis_scanner_url) : $cwis_scanner_url;
        ?>
        <div class="notice is-dismissible">
            <p style="font-size:108%">
                <span class="dashicons dashicons-shield" style="vertical-align:text-top;opacity:.7"></span>
                To make your site as secure as possible, take a moment to run a full system scanning in WebDefender Security:
                &nbsp;<a class="button button-primary" href="<?php echo esc_url($network_admin_url); ?>">Start Scan</a>
                <br>
                <em style="font-size:smaller">Once a week is generally a recommended frequency for a full system scan.
                  This allows your antivirus scanner to run the newest virus definition files against your server system.</em>
            </p>
        </div>
        <?php
    }

    /**
     * Register js for plugin deactivation action
     */
    public function admin_footer_script()
    {
        global $pagenow;

        if ('plugins.php' === $pagenow) {
            $actionUrl = $this->getActionUrl();
            $id = State::cwisAjaxId();
            $pass = State::cwisAjaxPass();

            echo '<script type="text/javascript">
                function cwis_deactivate_feedback(ev, data) {
                    ev.preventDefault();
                    ev.stopPropagation();
                    
                    if (data.close) {
                        tb_remove();
                        return;
                    }
                    
                    let reason = "";
                    if (data.el !== undefined && data.el !== null) {
                        reason = data.el.textContent;
                    }
                    
                    jQuery.post({
                        url: "'.$actionUrl.'",
                        data: {
                            id: "'.$id.'",
                            pass: "'.$pass.'",
                            action: "cwis_scanner",
                            subaction: "deactivation",
                            cwis_task: "feedback",
                            msg: reason
                        }
                    })
                    .fail(function( res ) {
                        if (window.cwis_deactivate_url !== undefined && 
                            window.cwis_deactivate_url !== null) {
                            window.location.href = window.cwis_deactivate_url;
                        }
                    })
                    .done(function( res ) {
                        if (window.cwis_deactivate_url !== undefined && 
                            window.cwis_deactivate_url !== null) {
                            window.location.href = window.cwis_deactivate_url;
                        }
                    });
                    
                    return false;
                }
        
                (function () {
                    jQuery("[data-slug=\'cwis-antivirus-malware-detected\'] .deactivate a").click(function () {
                    window.cwis_deactivate_url = this.getAttribute("href");
                    tb_show("Quick feedback", "/?TB_inline&inlineId=cwis_deactivate_modal_container");
                    jQuery("#TB_window").addClass("cwis_tb_window");
                    return false;
                    });
                }())
            </script>';

            echo '<style>
                #cwis_deactivate_modal_container_form * {
                    padding: 0 20px;
                }
                #cwis_deactivate_modal_container_form section:last-child {
                    margin-top: 20px;
                    padding-top: 20px;
                    border-top: 1px solid #dddddd;
                }
                #cwis_deactivate_modal_container_form button {
                    background: #f1f1f1;
                    border: none;
                    padding: 10px;
                    cursor: pointer;
                    transition: .3s;
                }
                .cwis_tb_window {
                    height: auto !important;
                }';

            if (is_rtl()) {
                echo '#TB_window {
                        text-align: right;
                    }
                    #TB_ajaxContent {
                        text-align: right;
                    }
                    #TB_ajaxWindowTitle {
                        padding-right: 39px;
                        padding-left: 0px;
                    }';
            }

            echo '</style>';

            wp_enqueue_script('thickbox');
            wp_enqueue_style('thickbox');

            echo '<div id="cwis_deactivate_modal_container" style="display:none;">
                <form id="cwis_deactivate_modal_container_form">
                  <h3>'.
                        "Why you are deactivating".
                        '</h3>
                  <section>
                    <div><input name="reason" type="radio"><label>'."I don't need a plugin".'</label></div>
                    <div><input name="reason" type="radio"><label>'."I encountered a glitch in the plugin".'</label></div>
                    <div><input name="reason" type="radio"><label>'."I found a better plugin".'</label></div>
                    <div><input name="reason" type="radio"><label>'."A different reason".'</label></div>
                    <div><input name="reason" type="radio"><label>'."Temporary shutdown for debugging".'</label></div>
                  </section>
                  <section>
                    <button onclick="cwis_deactivate_feedback(event,
                    {el:document.querySelector(\'#cwis_deactivate_modal_container_form :checked ~ label\')})">
                    Skip & deactivate</button>
                    <button onclick="cwis_deactivate_feedback(event,{close:true})"><b>Cancel</b></button>
                  </section>
                </form>
              </div>';
        }
    }

    /**
    * Register the JavaScripts for the admin area.
    *
    * @since    2.0.2
    * @param    string $hook
    */
    public function enqueue_scripts($hook)
    {

        // Enqueue scripts on plugin pages only
        if (false === strpos($hook, 'page_cwis-scanner')) {
            return null;
        }

        $js_files = array(
        // Load vendor files first
            'cwis_libs.min.js',
            'cwis_partials.js',
            'cwis_components.min.js',
            'cwis_main.min.js',
        );

        // Note: wp_enqueue_script() introduced in WordPress 2.1.0
        $plugin_scripts_url = $this->plugin_assets_url . 'js/';
        foreach ($js_files as $index => $js_file) {
            $handle = $this->get_plugin_name() . '-file' . $index;
            wp_enqueue_script($handle, $plugin_scripts_url . $js_file, array('jquery'), ( State::cwisDebug() > 0 ? time() : $this->get_version() ), 'all');
        }
        // Smart Protection setting
        $cwis_defender_settings = State::cnf("CWIS_DEFENDER");
        $cwsd_smartwaf_setting = (bool) $cwis_defender_settings['smartwaf'];

        $actionUrl = $this->getActionUrl();

        // Localizes CWIS core script (by the last handle used)
        $settings = [
            'debug'          => State::cwisDebug(),
            'actionUrl'      => $actionUrl,
            'currentVersion' => $this->get_version(),
            'pluginAction'   => 'cwis_scanner',
            'pluginAjaxId'   => State::cwisAjaxId(),
            'pluginAjaxPass' => State::cwisAjaxPass(),
            'pluginBaseUrl'  => $this->plugin_assets_url,
            'pluginMode'     => true,
            'pluginType'     => 'wordpress',
            'restNonce'      => State::cnf('CWIS_REST_NONCE'),
            'useCookies'     => true,
            'useDefender'    => $cwsd_smartwaf_setting,
        ];
        wp_localize_script($handle, 'CwisSettings', $settings);
    }

    /**
     * Get action url
     */
    private function getActionUrl()
    {
        $isHttps =
            (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on')
            || (isset($_SERVER['SERVER_PORT']) && (int) $_SERVER['SERVER_PORT'] === 443)
        ;

        $actionUrl = admin_url('admin-ajax.php');

        if ($isHttps && strpos($actionUrl, 'http://') !== false) {
            $actionUrl = str_replace('http://', 'https://', $actionUrl);
        } elseif (!$isHttps && strpos($actionUrl, 'https://') !== false) {
            $actionUrl = str_replace('https://', 'http://', $actionUrl);
        }

        return $actionUrl;
    }

    /**
    * Register the stylesheets for the admin area.
    *
    * @since    2.0.2
    * @param    string $hook
    */
    public function enqueue_styles($hook)
    {

        // Enqueue styles on plugin pages only
        if (false === strpos($hook, 'page_cwis-scanner')) {
            return null;
        }

        $css_files = array('vendor.css', 'select2.min.css', 'cwis_app.min.css', 'main.css');

        // Note: wp_enqueue_style() introduced in WordPress 2.6.0
        $plugin_styles_url = $this->plugin_assets_url . 'css/';
        foreach ($css_files as $index => $css_file) {
            wp_enqueue_style($this->get_plugin_name() . '-file' . $index, $plugin_styles_url . $css_file, array(),
            $this->get_version(), 'all');
        }

        if (is_rtl()) {
            $css_rtl_files = array('rtl.css');

            foreach ($css_rtl_files as $index => $css_file) {
                wp_enqueue_style( $this->get_plugin_name() . '-file' . ($index + 10),
                    $plugin_styles_url . $css_file, [],
                    $this->get_version(), 'all');
            }
        }
    }

    /**
    * Fills scanner's root API file "cwis-scan.php" with AJAX options.
    *
    * @since    1.0.5
    * @param    string $hook
    */
    public function update_scanner_options($hook)
    {
        static::set_defaults();
    }

    private function define_plugin_hooks()
    {
        if (is_admin()) {
            add_action('admin_bar_menu', [$this, 'enqueue_admin_bar_menu'], 70);
            add_action('admin_menu', [$this, 'enqueue_admin_area_menu']);
            add_action((is_multisite() ? 'network_' : '') . 'admin_notices', [$this, 'enqueue_admin_area_notices']);
            add_action('admin_enqueue_scripts', [$this, 'enqueue_styles']);
            add_action('admin_enqueue_scripts', [$this, 'update_scanner_options']);
            add_action('admin_enqueue_scripts', [$this, 'enqueue_scripts']);
            add_action('wp_' . (is_multisite() ? 'network_' : '') . 'dashboard_setup', [$this, 'add_widget']);
            //add_action('admin_menu', [$this, 'enqueue_updater_settings_menu']);
            add_action('admin_footer', [$this, 'admin_footer_script']);
            add_action('upgrader_process_complete', [$this, 'plugin_update_hook'], 10, 2);
        }
    }

    /**
    * Register all of the hooks related to the UPDATER functionality
    * of the plugin.
    *
    * @since   3.3.3
    * @access   private
    */
    private function define_updater_hooks()
    {
        // This defines all methods related to CWIS Updater functionality.
        $cwis_updater_methods = new Cwis_Updater_Methods();

        // Enable all background updates of WordPress
        add_filter('automatic_updater_disabled', '__return_false');

        // Enable Wordpress core automatic updates via filter (no arguments expected).
        add_action('init', [$cwis_updater_methods, 'override_auto_core_updates']);

        // Enable plugin automatic background updates via filter (2 arguments expected).
        add_filter('auto_update_plugin', [$cwis_updater_methods, 'override_auto_plugin_updates'], 10, 2);

        // Enable theme automatic background updates via filter (2 arguments expected).
        add_filter('auto_update_theme', [$cwis_updater_methods, 'override_auto_theme_updates'], 10, 2);

        // Overrides the WordPress.org API plugins update check (2 arguments expected).
        add_filter('http_request_args', [$cwis_updater_methods, 'override_api_update_check'], 10, 2);
    }

    public function enqueue_updater_settings_menu()
    {

        // Add a link to the "Plugin Updates" settings
        $func_settings = array($this, 'display_updater_settings_page');
        add_options_page('WebDefender Updater', 'WebDefender Updater', 'administrator', 'cwis-updater', $func_settings);

        // Add a link to the main menu
        add_submenu_page('cwis-scanner', 'Updater', 'Updater', 'manage_options', 'cwis-updater', $func_settings);
    }

    public function plugin_update_hook()
    {
        (new Register)();
    }

    /**
    * Creates the HTML output for the updater settings page (screen) displayed.
    * Page link: wp-admin/options-general.php?page=cwis-updater
    *
    * @since   3.3.0
    */
    public function display_updater_settings_page()
    {
        if (!current_user_can('manage_options')) {
            $message = esc_html__('You do not have sufficient permissions to access this page.', CWIS_PLUGIN_SLUG);
            $this->debug($message);
            wp_die($message);
        }

        require_once CWIS_PLUGIN_DIR_PATH . 'partials/updater/settings-page.php';
    }

    public function register() {
        if(strpos($_SERVER['REQUEST_URI'], 'wp-json/cwis/v5/rest') !== false) {
            register_rest_route( 'cwis/v5', '/rest', [ 'methods' => 'GET',  'callback' => [$this, 'rest'], 'permission_callback' => '__return_true' ] );
            register_rest_route( 'cwis/v5', '/rest', [ 'methods' => 'POST', 'callback' => [$this, 'rest'], 'permission_callback' => '__return_true' ] );
        }
    }

    public function api()  { include_once(__DIR__ . "/../../api.php"); die; }
    public function rest() { include_once(__DIR__ . "/../../rest.php"); die; }

    public static function set_defaults()
    {
        $adapter = new WpAdapter();
        // Its an old install!!
        if (!$adapter->getOption('swis_amd', false)) {

            if (is_file(State::resultsPath() . '/CWIS-LICENSE.dat')) {
                $lic = file_get_contents(State::resultsPath() . '/CWIS-LICENSE.dat');
            }
            if (is_dir(State::resultsPath())) {
                $files = new \RecursiveIteratorIterator(
                    new \RecursiveDirectoryIterator(State::resultsPath(), RecursiveDirectoryIterator::SKIP_DOTS),
                    \RecursiveIteratorIterator::CHILD_FIRST
                );

                foreach ($files as $fileinfo) {
                    $todo = ($fileinfo->isDir() ? 'rmdir' : 'unlink');
                    $todo($fileinfo->getRealPath());
                }
                if ($lic) {
                    file_put_contents(State::resultsPath() . '/CWIS-LICENSE.dat', $lic);
                }
            }

        }

        $utils = new CwisUtilities();
        $utils->createResultsDirectory();

        $cnf_main = [ 'CWIS_AJAX_ID', 'CWIS_AJAX_PASS', 'CWIS_REST_NONCE' ];

        foreach ($cnf_main as $index => $key) {
            if (!State::cnf($key) || settingsFileExist()) {
                $val = $adapter->getOption($key);
                if (!$val || settingsFileExist()) {
                    $config = settingsFileExist() ? readSettingsFile() : [];

                    $val = isset($config[$key]) ? $config[$key] : wp_generate_password(24, false);
                }
                State::setCnf($key, $val);

                if ($key == 'CWIS_REST_NONCE') {
                    //(new CwisLogger())->debugMessage('cwis_plugin_activated1');

                    delete_transient('cwis_plugin_activated');
                    set_transient('cwis_plugin_activated', true);
                }
            }
        }

        if (settingsFileExist()) {
            removSettingsFile();
        }

        // Get TOTP key
        $totp_key = State::cnf('CWIS_TOTP_KEY');
        if (!$totp_key) {
            $totp_key = CwisTOTP::gen_totp_key();
            State::setCnf('CWIS_TOTP_KEY', $totp_key);

            //(new CwisLogger())->debugMessage('cwis_plugin_activated2');

            delete_transient('cwis_plugin_activated');
            set_transient('cwis_plugin_activated', true);
        }
    }

    function cwis_plugin_after_activation() {
        // Check if the transient or option is set
        if (get_transient('cwis_plugin_activated')) {
            (new Register)();

            //(new CwisLogger())->debugMessage('cwis_plugin_after_activation');

            // Delete the transient or option to prevent this code from running again
            delete_transient('cwis_plugin_activated');
        }
    }

    public static function activate_cwis()
    {
        if (!extension_loaded('curl')) {
            wp_die( 'The plugin could not be activated: curl extension not found.', '',
                ['link_text' => "<< Back", 'link_url' => "/wp-admin/plugins.php"] );
        }

        static::set_defaults();

        $runtime = new CwisRuntime();
        $runtime->setMode(1);
        //(new CwisLogger())->debugMessage('cwis_plugin_activated3');

        delete_transient('cwis_plugin_activated');
        set_transient('cwis_plugin_activated', true);
    }

    public static function deactivate_cwis()
    {
        if (extension_loaded('curl')) {
            (new Deactivate())([]);
        }

        $runtime = new CwisRuntime();
        $runtime->setMode(0);
    }

    public static function uninstall_cwis()
    {
        if (extension_loaded('curl')) {
            (new Unregister())();
        }

        static::deactivate_cwis();
        // We can safely request filesystem credentials without any issues
        $creds = request_filesystem_credentials(site_url() . '/wp-admin/', '', false, false, array());

        delete_option('swis_amd');

        if (file_exists(ABSPATH . 'searchreplacedb2.php')) {
            unlink(ABSPATH . 'searchreplacedb2.php');
        }

        if (file_exists(ABSPATH . 'cwsd.php')) {
            unlink(ABSPATH . 'cwsd.php');
        }

        // Initialize the API
        if (!WP_Filesystem($creds)) {
            return false;
        }

        global $wp_filesystem;

        // Get upload path
        $upload_dir = wp_upload_dir();
        $upload_path = $upload_dir['basedir'] . '/cwis';

        // Delete the temporary files directory
        $wp_filesystem->rmdir($upload_path, true);
    }

    public function run()
    {
        add_action("wp_ajax_nopriv_cwis_scanner", [ $this, 'api' ]);
        add_action("wp_ajax_cwis_scanner",        [ $this, 'api' ]);
        add_action("wp_ajax_nopriv_cwis_rest",    [ $this, 'rest' ]);
        add_action("wp_ajax_cwis_rest",           [ $this, 'rest' ]);
        add_action("rest_api_init",               [ $this, 'register' ]);

        add_action('admin_init', [ $this, 'cwis_plugin_after_activation']);

        //$plugin = new Cwis('cwis', $version = State::pluginVersion());
        //$plugin->run();

        // Check if not AJAX, CRON, APP (Atom Publishing Protocol) or XMLRPC
        if (!defined('DOING_AJAX') && !defined('DOING_CRON')
            && !defined('APP_REQUEST') && !defined('XMLRPC_REQUEST')) {
            $this->define_plugin_hooks();
        }

        $this->define_updater_hooks();
    }
}
