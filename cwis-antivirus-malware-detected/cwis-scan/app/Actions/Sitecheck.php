<?php

namespace App\Actions;

use App\State;
use App\Library\CwisSiteCheck;
use App\Library\CwisStaticHelpers;
use App\Library\CwisUtilities;
use App\Library\CwisApi;

class Sitecheck extends BaseAction {

    public function __invoke(): ?array {
        return [ 'data' => json_decode(self::getCachedData(), true), 'success' => true ];
    }

    function getCachedData($minutes = 0) {

        // Use default results directory
        $utilities = new CwisUtilities();
        $utilities->setScanPath();
        $sitecheck_filepath = $utilities->defineFilePath('sitecheck');
        
        // Update expired sitecheck results or get cached data
        if (!is_file($sitecheck_filepath) || time() - filemtime($sitecheck_filepath) > $minutes * 0) {
            if ($data = CwisApi::fetch_sitecheck()) {
                file_put_contents($sitecheck_filepath, $data);
            } else {
                if ($data = CwisApi::fetch_sitecheck()) {
                    file_put_contents($sitecheck_filepath, $data);
                }
            }
        } else {
            $data = file_get_contents($sitecheck_filepath);
        }

        return $data;

    }

}
