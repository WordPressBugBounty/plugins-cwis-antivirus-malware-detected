<?php

namespace App\Actions;
use App\State;

include_once ABSPATH . 'wp-admin/includes/class-wp-upgrader-skin.php';
class CwisUpdaterSkin extends \WP_Upgrader_Skin {
  public function header() {}
  public function footer() {}
  public function bulk_header() {}
  public function bulk_footer() {}
  public function feedback( $feedback, ...$args ) { return; }
  public function error( $error ) { return $error; }
}

class Updater extends BaseAction
{
    public function __invoke($params): array
    {

      // Not namespaced, don't move to USE
      include_once ABSPATH . 'wp-admin/includes/class-wp-upgrader.php';
      include_once ABSPATH . 'wp-admin/includes/update.php';
      include_once ABSPATH . 'wp-admin/includes/plugin.php';
      include_once ABSPATH . 'wp-admin/includes/file.php';

      $slug = isset($params['slug']) ? $params['slug'] : false;

      if(!$slug) {
        return [ 'success' => false, 'error' => 'no_slug' ];
      }

      $q = new CwisUpdaterSkin();
      $updates = \get_plugin_updates();
      $upgrader = new \Plugin_Upgrader($q);

      foreach ( $updates as $plugin ) {
        if($plugin->update && $plugin->update->slug == $slug) {
          $result = $upgrader->upgrade($plugin->update->plugin);
        }
      }

      if($result == '1') {
        return [ 'success' => true, 'result' => $result ];
      } else {
        return [ 'success' => false, 'result' => $result ];
      }

    }
}
