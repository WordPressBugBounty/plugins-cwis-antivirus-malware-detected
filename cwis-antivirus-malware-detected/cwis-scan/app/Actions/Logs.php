<?php

namespace App\Actions;

use App\Library\Cwis_Defender_Filesystem;
use App\Library\CwisLoader;
use App\State;

class Logs extends BaseAction
{
    public function __invoke($log_lines = 100): array {

        $cwis_defender_filesystem = CwisLoader::get_class_instance(Cwis_Defender_Filesystem::class);
        $temp_dir_path = $cwis_defender_filesystem->create_temp_files_directory(State::workPath());
        $log_filename = $temp_dir_path . '/cwsd-guarder.log';

        $file_contents = '';
        if (is_readable($log_filename)) {
            $file = is_file($log_filename) ? file($log_filename) : array();
            $file_size = count($file);
            $file_start = ($log_lines >= 0) ? max(0, $file_size - $log_lines) : 0;
            for ($i = $file_start; $i < $file_size; $i++) {
                $file_contents .= trim($file[$i]) . "\n";
            }
        }

        // Set charset to UTF-8
        // Output file contents encoded (prevent zero-length by adding a space)
        $result = htmlentities($file_contents . ' ', ENT_NOQUOTES | ENT_IGNORE, "UTF-8");

        return $result;
    }
}
